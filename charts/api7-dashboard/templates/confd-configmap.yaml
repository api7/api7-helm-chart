{{- if .Values.prometheus.server.enabled -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: confd-config
  namespace: {{ .Release.Namespace }}
data:
  confd.toml: |
    backend = "etcdv3"
    confdir = "/etc/confd"
    nodes = [
    {{- if .Values.etcd.builtin }}
        "http://{{ .Release.Name }}-etcd.{{ .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.etcd.service.ports.client }}"
    {{- else }}
        {{- range $value := .Values.etcd.hosts }}
        "{{ $value }}",
        {{- end }}
    {{- end }}
    ]
    watch = true
    {{- if .Values.etcd.auth.rbac.enabled }}
    username = {{ .Values.etcd.auth.rbac.user | quote }}
    password = {{ .Values.etcd.auth.rbac.password | quote }}
    basic_auth = true
    {{ end }}
  api7.alertmanager.yaml.tmpl: |
    global:
    route:
      group_wait: 1s
      group_interval: 1m
      repeat_interval: 1m
      receiver: "api7-dashboard"
      routes:
    {{`{{range $alarm := gets "`}}{{ .Values.etcd.prefix }}{{`/management/alarm/*"}}
    {{$alarmJson := json $alarm.Value}}
    {{if eq $alarmJson.status 1.0}}
    {{if eq $alarmJson.rules_relation "or"}}
    {{range $alarmJson.rules}}
      - match:
          alarm: "{{$alarmJson.id}}"
          condition: "{{.metric}}{{.operator}}{{.value}}"
        receiver: "api7-dashboard"
        repeat_interval: "{{.repeat_interval}}"
    {{end}}
    {{else}}
      - match:
          alarm: "{{$alarmJson.id}}"
          condition: "all"
        receiver: "api7-dashboard"
        repeat_interval: "{{$alarmJson.repeat_interval}}"
    {{end}}
    {{end}}
    {{end}}`}}

    receivers:
      - name: "api7-dashboard"
        webhook_configs:
          - url: "http://{{ .Release.Name }}-dashboard.{{ .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.config.http.servicePort }}/apisix/admin/alarm-webhook?cluster_id=cluster_1"
            send_resolved: true
            http_config:
              bearer_token: {{ .Values.config.authentication.apikey }}
  api7.alertmanager.yaml.toml: |
    [template]
    src = "api7.alertmanager.yaml.tmpl"
    dest = "/root/alertmanager.yml"
    mode = "0644"
    keys = [
    "{{ .Values.etcd.prefix }}/management/alarm/",
    ]
    reload_cmd = "curl -XPOST 'http://127.0.0.1:9093/-/reload'"
  api7.prometheus.yaml.toml: |
    [template]
    src = "api7.prometheus.yaml.tmpl"
    dest = "/root/prometheus.yml"
    mode = "0644"
    keys = [
    "{{ .Values.etcd.prefix }}/management/gateways/"
    ]
    reload_cmd = "curl -XPOST 'http://127.0.0.1:9090/-/reload'"
  api7.prometheus.yaml.tmpl: |
    global:
      scrape_interval: 1s     # By default, scrape targets every 15 seconds.
      evaluation_interval: 1s
    # Alertmanager configuration
    alerting:
      alertmanagers:
        - static_configs:
            - targets:
                - {{ .Release.Name }}-alertmanager.{{ .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:9093

    rule_files:
      - api7.rules.yml

    # A scrape configuration containing exactly one endpoint to scrape:
    scrape_configs:
      - job_name: "apisix"
        scrape_interval: 1s
        metrics_path: "/apisix/prometheus/metrics"
        static_configs:
            - targets:
    {{`{{range $gateway := gets "`}}{{ .Values.etcd.prefix }}{{`/management/gateways/*"}}
    {{$gatewayJson := json $gateway.Value}}
                {{if ne $gatewayJson.metrics_host ""}}
                - {{$gatewayJson.metrics_host}}:{{$gatewayJson.metrics_port}}
                {{end}}
    {{end}}`}}
  api7.rules.yaml.toml: |
    [template]
    src = "api7.rules.yaml.tmpl"
    dest = "/root/api7.rules.yml"
    mode = "0644"
    keys = [
    "{{ .Values.etcd.prefix }}/management/alarm/"
    ]
    reload_cmd = "curl -XPOST 'http://127.0.0.1:9090/-/reload'"
  api7.rules.yaml.tmpl: |
    groups:
    - name: api7-alarm
      rules:
    {{`{{range $alarm := gets "`}}{{ .Values.etcd.prefix }}{{`/management/alarm/*"}}
    {{$alarmJson := json $alarm.Value}}
    {{if eq $alarmJson.status 1.0}}
    {{if eq $alarmJson.rules_relation "or"}}
    {{range $alarmJson.rules}}
      - alert: {{$alarmJson.name}}
        expr: {{.expr}}
    {{if not .for}}
    {{else}}
        for: {{.for}}
    {{end}}
        labels:
          alarm: "{{$alarmJson.id}}"
          condition: "{{.metric}}{{.operator}}{{.value}}"
        annotations:
          summary: {{$alarmJson.message}}
          description: {{$alarmJson.message}}
    {{end}}
    {{else}}
      - alert: {{$alarmJson.name}}
        expr: {{range $index, $expr := $alarmJson.rules}} {{if gt $index 0}}and{{end}} {{.expr}} {{end}}
        labels:
          alarm: "{{$alarmJson.id}}"
          condition: "all"
        annotations:
          summary: {{$alarmJson.message}}
          description: {{$alarmJson.message}}
    {{end}}
    {{end}}
    {{end}}`}}

{{- end -}}
