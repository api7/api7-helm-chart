#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "api7-dashboard.fullname" . }}
  namespace: {{ .Release.Namespace }}
data:
  conf.yaml: |-
    len: {{ len .Values.config.allowList }}
    conf:
      {{- if gt (len .Values.config.allowList) 0 }}
      allow_list:
        {{- range .Values.config.allowList }}
        - {{ . }}
        {{- end }}
      {{- end }}
      listen:
        host: 0.0.0.0     # `manager api` listening ip or host name
        port: {{ .Values.config.http.port }} # `manager api` listening port
      {{- if or .Values.prometheus.builtin (gt (len .Values.prometheus.clusters) 0) }}
      prometheus:
        host:
        {{- if .Values.prometheus.builtin }}
        - "https://{{ .Release.Name }}-prometheus-server.{{ .Release.Name }}.svc.{{ .Values.clusterDomain }}:80"
        {{- else -}}
          {{ range .Values.prometheus.clusters }}
        - {{ . }}
          {{ end }}
        {{- end -}}
      {{- end }}
      etcd_clusters:
        user_conf:           # etcd cluster_name, this is for store user info like user,role,workspace
          endpoints:
          - "{{ .Release.Name }}-etcd.{{ .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.etcd.service.port }}"
        cluster_1:         # etcd cluster_name
          endpoints:
          - "{{ .Release.Name }}-etcd.{{ .Release.Namespace }}.svc.{{ .Values.clusterDomain }}:{{ .Values.etcd.service.port }}"
          prefix: {{ .Values.config.etcdKeyPrefix | quote }}
      log:
        error_log:
          level: warn       # supports levels, lower to higher: debug, info, warn, error, panic, fatal
          file_path:
            logs/error.log  # supports relative path, absolute path, standard output
                            # such as: logs/error.log, /tmp/logs/error.log, /dev/stdout, /dev/stderr
        access_log:
          file_path:
            logs/access.log  # supports relative path, absolute path, standard output
                            # such as: logs/access.log, /tmp/logs/access.log, /dev/stdout, /dev/stderr
                            # log example: 2020-12-09T16:38:09.039+0800	INFO	filter/logging.go:46	/apisix/admin/routes/r1	{"status": 401, "host": "127.0.0.1:9000", "query": "asdfsafd=adf&a=a", "requestId": "3d50ecb8-758c-46d1-af5b-cd9d1c820156", "latency": 0, "remoteIP": "127.0.0.1", "method": "PUT", "errs": []}
    authentication:
      secret:
        qwerty              # secret for jwt token generation.
                            # NOTE: Highly recommended to modify this value to protect `manager api`.
                            # if it's default value, when `manager api` start , it will generate a random string to replace it.
      expire_time: 3600     # jwt token expire time, in second
      users:                # yamllint enable rule:comments-indentation
        - username: admin   # username and password for login `manager api`
          password: admin
        - username: user
          password: user
